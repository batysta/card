<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horários</title>
    <link rel="icon" href="https://simulador.batysta.com/img/logo.png" sizes="32x32">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Horários">
    <link rel="apple-touch-icon" href="https://simulador.batysta.com/img/logo.png">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Hor%C3%A1rios%22,%22short_name%22:%22Hor%C3%A1rios%22,%22display%22:%22standalone%22,%22start_url%22:%22.%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%230f766e%22,%22icons%22:[{%22src%22:%22https://simulador.batysta.com/img/logo.png%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22,%22purpose%22:%22any%20maskable%22}]}">

    <style>
        html, body {
            width: 100%;
            min-height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        #doc-title {
            margin: 0 0 12px 0;
            text-align: center;
            color: #0f172a;
        }

        .table-wrap {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
        }

        .tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 0 0 12px 0;
        }

        .tab-btn {
            border: 1px solid #cbd5e1;
            background: #ffffff;
            color: #0f172a;
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #0f766e;
            border-color: #0f766e;
            color: #ffffff;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #e2e8f0;
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background: #f1f5f9;
            font-weight: 700;
        }

        tbody td:first-child {
            background: #f1f5f9;
            font-weight: 700;
            text-align: center;
        }

        .weekday-cell {
            background: #f1f5f9;
            font-weight: 700;
            text-align: center;
        }

        .status {
            margin: 0 0 10px 0;
            text-align: center;
            color: #475569;
        }

        .empty-note {
            padding: 14px;
            text-align: center;
            color: #64748b;
        }

        #ios-install-prompt,
        #android-install-prompt {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #ffffff;
            color: #333;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            border: 1px solid #ddd;
            text-align: center;
        }

        #ios-install-prompt p,
        #android-install-prompt p {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        #android-install-prompt button,
        #ios-install-prompt button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

        .share-icon {
            width: 20px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <main class="app">
        <h1 id="doc-title">Horários</h1>
        <p id="load-status" class="status">Carregando planilha...</p>
        <div class="tabs">
            <button id="tab-btn-matutino" class="tab-btn active" type="button">Matutino</button>
            <button id="tab-btn-vespertino" class="tab-btn" type="button">Vespertino</button>
        </div>
        <div id="panel-matutino" class="tab-panel active">
            <div class="table-wrap">
                <table id="sheet-table-matutino"></table>
            </div>
        </div>
        <div id="panel-vespertino" class="tab-panel">
            <div class="table-wrap">
                <table id="sheet-table-vespertino"></table>
            </div>
        </div>
    </main>

    <div id="ios-install-prompt">
        <p><strong>Quer instalar este app no iPhone?</strong></p>
        <p>1. Toque em <strong>Compartilhar</strong> <img src="https://upload.wikimedia.org/wikipedia/commons/c/c8/Ei-share-apple.svg" class="share-icon"> no Safari.</p>
        <p>2. Toque em <strong>Adicionar à Tela de Início</strong>.</p>
        <p>3. Toque em <strong>Adicionar</strong> para confirmar.</p>
        <button onclick="document.getElementById('ios-install-prompt').style.display='none'">Fechar</button>
    </div>

    <div id="android-install-prompt">
        <p>Deseja instalar o app <strong>Horários</strong> no seu Android?</p>
        <button id="btn-install-android">Instalar Agora</button>
        <button onclick="document.getElementById('android-install-prompt').style.display='none'" style="background:#64748b;">Depois</button>
    </div>

    <script>
      const SHEET_PUB_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDpiBCZUArTzP8PCltSxSXwFKsvx8G-aRf9uDFvai0-YRhXMdoKmlw1aWEYq5PmnbYNeBJmyI-j642/pub';
      const SHEET_GVIZ_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDpiBCZUArTzP8PCltSxSXwFKsvx8G-aRf9uDFvai0-YRhXMdoKmlw1aWEYq5PmnbYNeBJmyI-j642/gviz/tq?tqx=out:csv';

      function parseCsv(text) {
        const rows = [];
        let row = [];
        let cell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i += 1) {
          const char = text[i];
          const next = text[i + 1];

          if (char === '"' && inQuotes && next === '"') {
            cell += '"';
            i += 1;
          } else if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            row.push(cell);
            cell = '';
          } else if ((char === '\n' || char === '\r') && !inQuotes) {
            if (char === '\r' && next === '\n') i += 1;
            row.push(cell);
            rows.push(row);
            row = [];
            cell = '';
          } else {
            cell += char;
          }
        }

        if (cell.length > 0 || row.length > 0) {
          row.push(cell);
          rows.push(row);
        }

        return rows.filter((r) => r.some((c) => c.trim() !== ''));
      }

      function isWeekdayCell(value) {
        const normalized = (value || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toUpperCase();
        const weekdays = ['SEGUNDA', 'TERCA', 'QUARTA', 'QUINTA', 'SEXTA'];
        return weekdays.some((day) => normalized.includes(day));
      }

      function renderTable(rows, tableId, emptyMessage) {
        const table = document.getElementById(tableId);
        table.innerHTML = '';

        if (!rows.length) {
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.className = 'empty-note';
          td.textContent = emptyMessage || 'Sem dados para exibir.';
          td.colSpan = 12;
          tr.appendChild(td);
          tbody.appendChild(tr);
          table.appendChild(tbody);
          return;
        }

        const header = rows[0];
        const thead = document.createElement('thead');
        const trHead = document.createElement('tr');
        header.forEach((h) => {
          const th = document.createElement('th');
          th.textContent = h || '-';
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        const tbody = document.createElement('tbody');
        rows.slice(1).forEach((r) => {
          const tr = document.createElement('tr');
          header.forEach((_, i) => {
            const td = document.createElement('td');
            const cellText = (r[i] || '').trim();
            td.textContent = cellText;
            if (isWeekdayCell(cellText)) {
              td.classList.add('weekday-cell');
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);
      }

      async function fetchCsvRows(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) return [];
        const csv = await res.text();
        return parseCsv(csv);
      }

      async function fetchSheetRows(sheetName, gidCandidates = []) {
        const candidates = [sheetName, sheetName.toLowerCase(), sheetName.toUpperCase()];
        for (const candidate of candidates) {
          const urls = [
            `${SHEET_PUB_BASE_URL}?output=csv&sheet=${encodeURIComponent(candidate)}`,
            `${SHEET_GVIZ_BASE_URL}&sheet=${encodeURIComponent(candidate)}`
          ];
          try {
            for (const url of urls) {
              const rows = await fetchCsvRows(url);
              if (rows.length) return rows;
            }
          } catch (err) {
            console.error(`Erro ao carregar aba ${candidate}:`, err);
          }
        }

        for (const gid of gidCandidates) {
          const urls = [
            `${SHEET_PUB_BASE_URL}?output=csv&single=true&gid=${encodeURIComponent(gid)}`,
            `${SHEET_GVIZ_BASE_URL}&gid=${encodeURIComponent(gid)}`
          ];
          try {
            for (const url of urls) {
              const rows = await fetchCsvRows(url);
              if (rows.length) return rows;
            }
          } catch (err) {
            console.error(`Erro ao carregar gid ${gid}:`, err);
          }
        }

        return [];
      }

      async function fetchSheetRowsByGid(gid) {
        const urls = [
          `${SHEET_PUB_BASE_URL}?output=csv&single=true&gid=${encodeURIComponent(gid)}`,
          `${SHEET_GVIZ_BASE_URL}&gid=${encodeURIComponent(gid)}`
        ];
        for (const url of urls) {
          try {
            const rows = await fetchCsvRows(url);
            if (rows.length) return rows;
          } catch (err) {
            console.error(`Erro ao carregar gid fixo ${gid}:`, err);
          }
        }
        return [];
      }

      async function loadSheets() {
        const status = document.getElementById('load-status');
        try {
          const [matutinoRows, vespertinoRows] = await Promise.all([
            fetchSheetRows('Matutino', [0]),
            fetchSheetRowsByGid(2012795581)
          ]);

          renderTable(
            matutinoRows,
            'sheet-table-matutino',
            'Não foi possível carregar a aba Matutino.'
          );
          renderTable(
            vespertinoRows,
            'sheet-table-vespertino',
            'Não foi possível carregar a aba Vespertino. Se quiser, me passe o gid dessa aba para eu fixar com precisão.'
          );

          if (!matutinoRows.length && !vespertinoRows.length) {
            throw new Error('Nenhuma aba retornou dados');
          }
          status.textContent = '';
        } catch (err) {
          status.textContent = 'Não foi possível carregar os horários agora.';
          console.error(err);
        }
      }

      loadSheets();
    </script>

    <script>
      const tabBtnMatutino = document.getElementById('tab-btn-matutino');
      const tabBtnVespertino = document.getElementById('tab-btn-vespertino');
      const panelMatutino = document.getElementById('panel-matutino');
      const panelVespertino = document.getElementById('panel-vespertino');

      function setActiveTab(tabName) {
        const isMatutino = tabName === 'matutino';
        tabBtnMatutino.classList.toggle('active', isMatutino);
        tabBtnVespertino.classList.toggle('active', !isMatutino);
        panelMatutino.classList.toggle('active', isMatutino);
        panelVespertino.classList.toggle('active', !isMatutino);
      }

      tabBtnMatutino.addEventListener('click', () => setActiveTab('matutino'));
      tabBtnVespertino.addEventListener('click', () => setActiveTab('vespertino'));
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          const swCode = `
            self.addEventListener('install', (e) => self.skipWaiting());
            self.addEventListener('fetch', (e) => e.respondWith(fetch(e.request)));
          `;
          const blob = new Blob([swCode], { type: 'text/javascript' });
          const url = URL.createObjectURL(blob);
          navigator.serviceWorker.register(url).catch((err) => console.log('SW Erro:', err));
        });
      }
    </script>

    <script>
      const INSTALL_PROMPT_AUTO_CLOSE_MS = 5000;

      const isIos = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
      };

      const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

      if (isIos() && !isInStandaloneMode()) {
        const iosPrompt = document.getElementById('ios-install-prompt');
        iosPrompt.style.display = 'block';
        setTimeout(() => {
          iosPrompt.style.display = 'none';
        }, INSTALL_PROMPT_AUTO_CLOSE_MS);
      }
    </script>

    <script>
      let deferredPrompt;
      const androidPrompt = document.getElementById('android-install-prompt');
      const btnInstallAndroid = document.getElementById('btn-install-android');

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        androidPrompt.style.display = 'block';
        setTimeout(() => {
          androidPrompt.style.display = 'none';
        }, INSTALL_PROMPT_AUTO_CLOSE_MS);
      });

      btnInstallAndroid.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          androidPrompt.style.display = 'none';
        }
      });

      window.addEventListener('appinstalled', () => {
        androidPrompt.style.display = 'none';
      });
    </script>
</body>
</html>
